'use strict'

/**
 * @module      gpu/nvidia/persistance-mode
 * @desc        Nvidia GPU의 persistance 관련 모듈
 * @since       1.0.0
 * @date        2020-01-16
 * @see         {@link https://developer.download.nvidia.com/compute/DCGM/docs/nvidia-smi-367.38.pdf nvidia-smi}
*/

const exec = require('child_process').exec,
    gpuInfoGetter = require('./gpu-info-getter')

Object.defineProperties(
    exports,
    {
        /**
         * @name    isEnablePersistanceMode
         * @desc    GPU persistance mode의 세팅 여부를 리턴
         * @function
         * @static
         * @public
         * @param   {Number=}           deviceNo    - 조회할 GPU device number<br/>
         *                                            전달된 값이 없으면 전체 GPU들을 조회<br/>
         *                                            하나라도 persistance mode가 세팅되어 있지 않은 경우 false, 전체 GPU에 persistance mode가 세팅되어 있으면 true
         * @returns {Promise<Boolean>}  persistance mode 세팅 여부
         * @since   1.0.0
         * @date    2020-01-16
        */
        isEnablePersistanceMode: {
            enumerable: true,
            value: deviceNo => {
                return gpuInfoGetter.gpus
                    .then(data => {
                        let gpu

                        if (typeof deviceNo === 'number') {
                            gpu = data.gpus.find(gpu => gpu.deviceNo === deviceNo)

                            if (gpu) {
                                return gpu.persistenceMode
                            } else {
                                throw new Error(`does not exist GPU (device number : ${deviceNo})`)
                            }
                        } else {
                            return data.gpus.reduce(
                                (result, gpu) => gpu.persistenceMode ? result : gpu.persistenceMode,
                                true)
                        }
                   })
            }
        },
        /**
         * @name    setEnablePersistanceMode
         * @desc    GPU persistance mode 세팅
         * @function
         * @static
         * @public
         * @param   {Boolean}   isEnable    - persistance mode 세팅 값
         * @param   {Number=}   deviceNo    - 세팅할 GPU device number<br/>
         *                                    전달된 값이 없으면 전체 GPU에 대해 세팅
         * @returns {Promise}   persistance mode 세팅 여부
         * @since   1.0.0
         * @date    2020-01-16
        */
        setEnablePersistanceMode: {
            enumerable: true,
            value: (isEnable, deviceNo) => {
                return new Promise((resolve, reject) => {
                    exec(
                        ['nvidia-smi', '-pm', isEnable ? 1 : 0].concat(typeof deviceNo === 'number' ? deviceNo : []).join(' '),
                        (err, stdout, stderr) => err ? reject(err) : resolve())
                })
            }
        }
    })
