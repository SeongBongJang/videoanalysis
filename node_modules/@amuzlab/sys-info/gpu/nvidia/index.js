'use strict'

/**
 * @module      gpu/nvidia
 * @desc        nvidia-smi를 통해 GPU 정보를 조회
 * @since       1.0.0
 * @date        2020-01-16
 * @see         {@link https://developer.download.nvidia.com/compute/DCGM/docs/nvidia-smi-367.38.pdf nvidia-smi}
*/

const config = require('../../config'),
    abstractGPUModule = require('../abstract-gpu-module'),
    gpuInfoGetter = require('./gpu-info-getter'),
    persistanceMode = require('./persistence-mode'),
    loadBalancer = require('./load-balancer')

// GPU default setting
typeof config.gpu.persistanceMode !== 'boolean' && (config.gpu.persistanceMode = true)

Object.defineProperties(
    abstractGPUModule,
    {
        /**
         * @name    get:gpus
         * @desc    gpu 상태 정보 조회
         * @function
         * @static
         * @public
         * @returns {Promise<Object>}   gpu 정보
         * @since   1.0.0
         * @date    2020-01-16
         * @see     {@link module:gpu/abstract-gpu-module.get:gpus abstract-gpu-module.gpus}
        */
        gpus: {
            get: () => gpuInfoGetter.gpus
        },
        /**
         * @name    getGPU
         * @desc    전달된 기준으로 gpu 정보 조회
         * @function
         * @static
         * @public
         * @param
         * @param   {Function|Number|String}    algorithm   gpu 정보를 조회할 기준<br/>
         *                                                  <ul>
         *                                                    <li>Function : callback 함수가 true를 리턴하는 GPU의 정보를 리턴 (parameter : gpu)</li>
         *                                                    <li>Number : deviceNo가 전달된 값과 동일한 GPU 정보 리턴</li>
         *                                                    <li>String : 정의된 Load balancing algorithm을 사용하여 GPU 정보 리턴</li>
         *                                                  </ul>
         * @returns {Object}    gpu     전달된 기준에 의해 조회된 GPU 정보
         * @since   1.0.0
         * @date    2020-01-16
         * @see     {@link module:gpu/abstract-gpu-module.getGPU abstract-gpu-module.getGPU}
        */
        getGPU: {
            enumerable: true,
            configurable: true,
            value: algorithm => loadBalancer.getGPU(algorithm)
        },
        /**
         * @name    persistance
         * @desc    NVIDIA persistance mode 관련 모듈
         * @type    {module:gpu/nvidia/persistance-mode}
         * @static
         * @public
         * @since   1.0.0
         * @date    2020-01-16
         * @see     {@link module:gpu/nvidia/persistance-mode persistance-mode}
        */
        persistance: {
            enumerable: true,
            value: persistanceMode
        }
    })

module.exports = exports = abstractGPUModule
